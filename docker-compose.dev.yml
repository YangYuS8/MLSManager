# ML-Server-Manager Development Environment
# Docker Compose configuration with hot-reload support
# All environment variables are loaded from .env.dev

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: mlsmanager-dev-db
    restart: unless-stopped
    env_file:
      - .env.dev
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mlsmanager}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ (for Celery task queue)
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: mlsmanager-dev-rabbitmq
    restart: unless-stopped
    env_file:
      - .env.dev
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API Server (Development with hot-reload)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
      network: host
      args:
        - HTTP_PROXY=${HTTP_PROXY:-}
        - HTTPS_PROXY=${HTTPS_PROXY:-}
        - http_proxy=${HTTP_PROXY:-}
        - https_proxy=${HTTPS_PROXY:-}
        - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}
    container_name: mlsmanager-dev-backend
    restart: unless-stopped
    env_file:
      - .env.dev
    environment:
      # Override with Docker-internal URLs
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-mlsmanager}:${POSTGRES_PASSWORD:-mlsmanager_secret}@db:5432/${POSTGRES_DB:-mlsmanager}
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER:-mlsmanager}:${RABBITMQ_DEFAULT_PASS:-mlsmanager_secret}@rabbitmq:5672//
    volumes:
      # Mount source code for hot-reload
      - ./backend:/app
      # Exclude virtual environment
      - /app/.venv
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  # Frontend (Development with Vite HMR)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
      network: host
      args:
        - HTTP_PROXY=${HTTP_PROXY:-}
        - HTTPS_PROXY=${HTTPS_PROXY:-}
        - http_proxy=${HTTP_PROXY:-}
        - https_proxy=${HTTPS_PROXY:-}
        - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}
    container_name: mlsmanager-dev-frontend
    restart: unless-stopped
    env_file:
      - .env.dev
    volumes:
      # Mount source code for hot-reload
      - ./frontend:/app
      # Exclude node_modules
      - /app/node_modules
    ports:
      - "5173:5173"
    depends_on:
      - backend

  # Worker Agent (Go version with hot-reload)
  # Comment out this service if you don't want to deploy a local worker node
  worker:
    build:
      context: ./worker_agent
      dockerfile: Dockerfile.dev
      network: host
      args:
        - HTTP_PROXY=${HTTP_PROXY:-}
        - HTTPS_PROXY=${HTTPS_PROXY:-}
        - http_proxy=${HTTP_PROXY:-}
        - https_proxy=${HTTPS_PROXY:-}
        - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}
    container_name: mlsmanager-dev-worker
    restart: unless-stopped
    env_file:
      - .env.dev
    environment:
      # Override with Docker-internal URL
      AGENT_MASTER_URL: http://backend:8000
    volumes:
      # Mount source code for hot-reload
      - ./worker_agent:/app
      # Persistent data directory
      - worker_dev_data:/data
      # Token storage
      - worker_dev_token:/etc/ml-agent
    depends_on:
      - backend

  # Code-Server (VS Code in Browser for Project Editing)
  code-server:
    image: codercom/code-server:latest
    container_name: mlsmanager-dev-codeserver
    restart: unless-stopped
    # Run as current user to avoid permission issues with mounted volumes
    user: "${UID:-1000}:${GID:-1000}"
    env_file:
      - .env.dev
    environment:
      # Disable telemetry
      CS_DISABLE_GETTING_STARTED_OVERRIDE: "true"
    volumes:
      # Mount projects directory (shared with backend)
      - ${PROJECTS_ROOT_PATH:-./projects}:/home/coder/workspace:rw
      # Persist code-server config (extensions, settings)
      - ./.code-server/config:/home/coder/.config:rw
      # Persist workspace states and data
      - ./.code-server/data:/home/coder/.local/share/code-server:rw
    ports:
      - "${CODE_SERVER_PORT:-8443}:8000"
    # Development mode: no password required
    command: ["--auth=none", "--disable-telemetry"]

volumes:
  postgres_dev_data:
  worker_dev_data:
  worker_dev_token:
