# ML-Server-Manager Production Environment
# All environment variables are loaded from .env

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: mlsmanager-db
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mlsmanager}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ (for Celery task queue)
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: mlsmanager-rabbitmq
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API Server
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mlsmanager-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Ensure Docker-internal URLs are used
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672//
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend (production build served by nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mlsmanager-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend

  # Worker Agent (Go version - high performance local worker node)
  # Comment out this service if you don't want to deploy a local worker node
  # For production, you may want to deploy workers on separate servers
  worker:
    build:
      context: ./worker_agent
      dockerfile: Dockerfile
    container_name: mlsmanager-worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Ensure Docker-internal URL is used
      AGENT_MASTER_URL: http://backend:8000
    volumes:
      # Persistent data directory for datasets and job workspaces
      - worker_data:/data
      # Token storage (persists agent registration)
      - worker_token:/etc/ml-agent
      # Optional: Mount host Docker socket for Docker-in-Docker job execution
      # - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      backend:
        condition: service_healthy

  # Code-Server (VS Code in Browser for Project Editing)
  code-server:
    image: codercom/code-server:latest
    container_name: mlsmanager-codeserver
    restart: unless-stopped
    env_file:
      - .env
    environment:
      PASSWORD: ${CODE_SERVER_PASSWORD:-mlsmanager}
    volumes:
      # Mount projects directory
      - ${PROJECTS_ROOT_PATH:-./projects}:/home/coder/workspace:rw
      # Persist code-server config (extensions, settings)
      - code_server_config:/home/coder/.config
      # Persist workspace states and data
      - code_server_data:/home/coder/.local/share/code-server
    ports:
      - "${CODE_SERVER_PORT:-8443}:8000"
    command: ["--auth=password", "--disable-telemetry"]
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  postgres_data:
  worker_data:
  worker_token:
  code_server_config:
  code_server_data:
